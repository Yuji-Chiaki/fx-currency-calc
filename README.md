# FX証拠金計算ツール

## プロジェクト概要
- **名前**: FX証拠金計算ツール
- **目的**: FX取引における必要証拠金と損益をリアルタイムで簡単に計算できるウェブアプリケーション
- **特徴**: 
  - 主要通貨ペアと高金利通貨ペア（トルコリラ、メキシコペソ、南アフリカランド）に対応
  - 証拠金計算と損益シミュレーションの2つの機能
  - **実際の為替レートを使用（FXRatesAPI - リアルタイムFX市場レート）** 🌟本番対応
  - レスポンシブデザインでモバイル対応

## 実装済み機能

### ✅ 完了した機能

1. **証拠金計算機能（拡張版）**
   - 通貨ペア選択（7通貨ペア対応）
   - ロット数入力（0.01ロット単位）
   - レバレッジ選択（1倍～888倍）
   - **入金証拠金の入力** ⭐NEW
   - **ロスカット率の選択（20%, 50%, 100%）** ⭐NEW
   - 必要証拠金の自動計算
   - ポジション総額の表示
   - 1pipsあたりの価値計算
   - **証拠金維持率の計算と表示** ⭐NEW
   - **余剰証拠金の表示** ⭐NEW
   - **ロスカットレートの計算** ⭐NEW
   - **ロスカットまでのpips表示** ⭐NEW
   - **取引可否判定** ⭐NEW

2. **損益シミュレーション機能**
   - エントリーレートと決済レートの入力
   - 買い/売りポジションの選択
   - 損益金額の計算
   - pips計算
   - 損益率の表示

3. **リアルタイムレート表示（本番対応）** 🌟
   - 7通貨ペアのレート表示
   - 主要通貨ペアと高金利通貨ペアの区別
   - **1分ごとの自動更新（実際の市場レート）** ⭐変更
   - **FXRatesAPI使用（リアルタイムFX市場データ）** 🌟NEW
   - **完全無料・APIキー不要** 🌟NEW
   - **フォールバック機能（API障害時も動作）** 🌟NEW
   - **高精度（実際のFX市場レートと一致）** 🌟NEW

4. **UI/UX**
   - モダンなタブインターフェース
   - TailwindCSSによるレスポンシブデザイン
   - Font Awesomeアイコン統合
   - カラフルな結果表示カード
   - スムーズなアニメーション効果
   - **証拠金維持率の色分け表示（危険/警告/安全）** ⭐NEW
   - **証拠金不足時の警告メッセージ** ⭐NEW

### 対応通貨ペア

**主要通貨ペア:**
- USD/JPY（米ドル/円）
- EUR/JPY（ユーロ/円）
- GBP/JPY（英ポンド/円）
- AUD/JPY（豪ドル/円）

**高金利通貨ペア:**
- TRY/JPY（トルコリラ/円）
- MXN/JPY（メキシコペソ/円）
- ZAR/JPY（南アフリカランド/円）

### レバレッジオプション
1倍、10倍、25倍、50倍、100倍、200倍、400倍、500倍、888倍

## 機能エントリーURI

### API エンドポイント

| エンドポイント | メソッド | 説明 | パラメータ |
|--------------|---------|------|-----------|
| `/` | GET | メインページ表示 | - |
| `/api/currency-pairs` | GET | 通貨ペア一覧取得 | - |
| `/api/exchange-rates` | GET | 為替レート取得 | - |
| `/api/calculate-margin` | POST | 証拠金計算 | `currencyPair`, `lots`, `leverage`, `rate`, `deposit`, `lossCutRate` |
| `/api/calculate-profit` | POST | 損益計算 | `currencyPair`, `lots`, `position`, `entryRate`, `exitRate` |

### レスポンス例

**証拠金計算レスポンス（拡張版）:**
```json
{
  "success": true,
  "data": {
    "currencyPair": "USDJPY",
    "lots": 1,
    "leverage": 25,
    "rate": 149.85,
    "deposit": 100000,
    "units": 10000,
    "positionValue": 1498500,
    "requiredMargin": 59940,
    "effectiveMargin": 100000,
    "marginRate": 166.83,
    "surplusMargin": 40060,
    "pipValue": 100,
    "lossCutRate": 50,
    "lossCutPrice": 142.85,
    "pipsToLossCut": 700.3,
    "canTrade": true
  }
}
```

**損益計算レスポンス:**
```json
{
  "success": true,
  "data": {
    "currencyPair": "USDJPY",
    "lots": 1,
    "entryRate": 149.50,
    "exitRate": 150.00,
    "position": "buy",
    "pips": 50,
    "profit": 5000,
    "profitPercent": 0.33
  }
}
```

## 未実装機能

### 🔜 今後の実装予定

1. **外部為替API連携**
   - ExchangeRate-API または Fixer.io との統合
   - リアルタイムの実際の市場レート取得
   - より頻繁なレート更新

2. **計算履歴機能**
   - 過去の計算結果の保存（ローカルストレージ）
   - 履歴の一覧表示
   - 履歴のエクスポート機能

3. **追加通貨ペア**
   - CHF/JPY（スイスフラン/円）
   - CAD/JPY（カナダドル/円）
   - NZD/JPY（ニュージーランドドル/円）
   - その他のクロス通貨ペア

4. **高度な計算機能**
   - スワップポイント計算
   - 複数ポジション管理
   - リスク管理計算（最大損失額、リスクリワード比）
   - ロット数の推奨計算

5. **データ永続化**
   - Cloudflare D1データベース統合
   - ユーザー設定の保存
   - お気に入り通貨ペアの保存

6. **レート通知機能**
   - 目標レート到達時のアラート
   - ブラウザプッシュ通知

## 推奨される次のステップ

### 優先度：高
1. **外部為替API統合** - 実際の市場レートを取得
2. **エラーハンドリング強化** - ユーザー入力のバリデーション改善
3. **レスポンシブデザイン最適化** - モバイル表示の微調整

### 優先度：中
4. **計算履歴機能** - ローカルストレージを使用した履歴保存
5. **スワップポイント計算** - 日次スワップ損益の計算機能
6. **パフォーマンス最適化** - コード最適化とバンドルサイズ削減

### 優先度：低
7. **ダークモード対応** - テーマ切り替え機能
8. **多言語対応** - 英語版の追加
9. **PWA化** - オフライン対応とインストール可能化

## URLs

- **開発環境**: https://3000-ibjcaptxlbcp7he1m4auo-b32ec7bb.sandbox.novita.ai
- **本番環境**: 未デプロイ（Cloudflare Pagesへのデプロイが必要）

## 為替レートAPI

### 🌟 FXRatesAPI（リアルタイムFX市場レート）

このアプリケーションは**実際のFX市場レート**を使用しています。

**API情報:**
- **提供元**: FXRatesAPI (https://fxratesapi.com/)
- **データソース**: リアルタイムFX市場データ
- **更新頻度**: リアルタイム更新
- **料金**: 完全無料
- **APIキー**: 不要
- **レート制限**: なし
- **精度**: 実際のFX市場レートと一致（USD/JPY = 152.64円など）

**特徴:**
- ✅ リアルタイムFX市場レート（高精度）
- ✅ 完全無料・登録不要
- ✅ APIキー不要で即座に利用可能
- ✅ 実際の市場レートと一致
- ✅ フォールバック機能実装（API障害時も動作継続）
- ✅ 1分ごとの自動更新

**取得している通貨ペア:**
- USD/JPY（米ドル/円）- **152.64円**（実際のレート）
- EUR/JPY（ユーロ/円）- **181.14円**
- GBP/JPY（英ポンド/円）- **207.99円**
- AUD/JPY（豪ドル/円）- **108.71円**
- TRY/JPY（トルコリラ/円）- **3.50円**
- MXN/JPY（メキシコペソ/円）- **8.88円**
- ZAR/JPY（南アフリカランド/円）- **9.62円**

**精度の向上:**
以前のFrankfurter API（ECB）では153.61円と表示されていたUSD/JPYが、FXRatesAPIでは152.64円と実際の市場レートと一致するようになりました。

## データアーキテクチャ

### データモデル

**通貨ペア（Currency Pair）:**
```typescript
{
  code: string;        // 通貨ペアコード（例: USDJPY）
  name: string;        // 表示名（例: 米ドル/円）
  category: string;    // カテゴリ（major, high-yield）
  minLot: number;      // 最小ロット数
  maxLot: number;      // 最大ロット数
}
```

**為替レート（Exchange Rate）:**
```typescript
{
  [currencyCode: string]: number;  // 通貨ペアコードと現在レート
  timestamp: string;               // レート取得時刻
}
```

### ストレージサービス
- **現在**: メモリ内データ（通貨ペア設定のみ）
- **計画中**: Cloudflare D1（SQLite）またはKV（キー・バリュー）
- **外部API**: FXRatesAPI（リアルタイムFX市場データ）🌟実装済み

### データフロー
1. フロントエンドがページ読み込み時にAPIを呼び出し
2. バックエンド（Hono）がFXRatesAPIから最新レートを取得 🌟
3. 取得したレートをJPY建てに変換して処理・計算 🌟
4. 結果をJSON形式でレスポンス
5. フロントエンドが結果を整形して表示
6. 1分ごとに自動的に最新レートを再取得（実際のFX市場レート）🌟
7. API障害時はフォールバックデータで動作継続 🌟

## ユーザーガイド

### 証拠金計算の使い方（拡張版）

1. **通貨ペアを選択**
   - プルダウンから取引したい通貨ペアを選択
   - 主要通貨ペアまたは高金利通貨ペアから選択可能

2. **ロット数を入力**
   - 取引したいロット数を入力（1ロット = 10,000通貨単位）
   - 最小0.01ロットから入力可能

3. **レバレッジを選択**
   - 使用するレバレッジを選択（1倍～888倍）
   - 日本国内業者は通常25倍まで

4. **入金証拠金を入力** ⭐NEW
   - 口座に入金した証拠金額を入力（円）
   - 例：100,000円

5. **ロスカット率を選択** ⭐NEW
   - ロスカット基準となる証拠金維持率を選択
   - 20%（一般的）、50%（国内標準）、100%（厳格）から選択

6. **計算実行**
   - 「証拠金を計算する」ボタンをクリック
   - 以下の情報が表示されます：
     - 必要証拠金
     - ポジション総額
     - 1pipsの価値
     - 有効証拠金
     - 証拠金維持率（色分け表示：赤=危険、オレンジ=警告、緑=安全）
     - 余剰証拠金
     - 取引可否判定
     - ロスカットレート
     - ロスカットまでのpips

### 損益シミュレーションの使い方

1. **通貨ペアとロット数を入力**
   - 証拠金計算と同様に選択

2. **ポジションを選択**
   - 買い（ロング）または売り（ショート）を選択

3. **レートを入力**
   - エントリーレート（注文価格）を入力
   - 決済レート（決済予定価格）を入力

4. **シミュレーション実行**
   - 「損益を計算する」ボタンをクリック
   - 損益金額、pips、損益率が表示されます

### 計算例

**例: USD/JPY 1ロット、レバレッジ25倍、入金証拠金10万円で取引**
- 現在レート: 149.85円
- ポジション総額: 1,498,500円
- 必要証拠金: 59,940円
- 有効証拠金: 100,000円
- 証拠金維持率: 166.83%（安全圏）
- 余剰証拠金: 40,060円
- 1pipsの価値: 100円
- ロスカットレート: 142.85円（ロスカット率50%の場合）
- ロスカットまで: 700.3pips

**例: USD/JPY 買いポジション**
- エントリー: 149.50円
- 決済: 150.00円
- 損益: +5,000円（+50pips）

## デプロイメント

### ローカル開発
```bash
# 依存関係のインストール
npm install

# ビルド
npm run build

# 開発サーバー起動（PM2使用）
npm run clean-port
pm2 start ecosystem.config.cjs

# テスト
npm run test
```

### Cloudflare Pages デプロイ
```bash
# ビルド
npm run build

# デプロイ
npm run deploy:prod

# または手動デプロイ
npx wrangler pages deploy dist --project-name webapp
```

### プロジェクト構造
```
webapp/
├── src/
│   ├── index.tsx          # メインアプリケーション（Hono）
│   └── renderer.tsx       # レンダラー設定
├── public/
│   └── static/
│       ├── app.js         # フロントエンドJavaScript
│       └── style.css      # カスタムCSS
├── dist/                  # ビルド出力（自動生成）
├── ecosystem.config.cjs   # PM2設定
├── wrangler.jsonc         # Cloudflare設定
├── package.json           # 依存関係とスクリプト
├── tsconfig.json          # TypeScript設定
├── vite.config.ts         # Vite設定
└── README.md             # このファイル
```

## 技術スタック

- **バックエンド**: Hono v4（軽量Webフレームワーク）
- **フロントエンド**: Vanilla JavaScript
- **スタイリング**: TailwindCSS（CDN）
- **アイコン**: Font Awesome 6
- **HTTPクライアント**: Axios
- **デプロイ**: Cloudflare Pages/Workers
- **開発環境**: Vite（ビルドツール）
- **プロセス管理**: PM2

## 注意事項

⚠️ **重要な免責事項**

- このツールは**教育・参考目的のアプリケーション**です
- 表示されているレートは**FXRatesAPIのリアルタイムデータ**を使用していますが、FX業者のレートとは若干異なる場合があります
- **実際の取引には必ず各FX業者の公式ツールをご利用ください**
- FX取引には高いリスクが伴います。**投資は自己責任で行ってください**
- 1ロット = 10,000通貨単位で計算しています（業者によって異なる場合があります）
- レートは1分ごとに更新されますが、リアルタイムのティック単位の変動には対応していません

## ライセンス

このプロジェクトは教育目的で作成されています。

## 最終更新日

2026年2月12日

**主な更新内容:**
- 🌟 **FXRatesAPIに変更（実際のFX市場レートと一致）**
- 🌟 **精度向上：USD/JPY 152.64円（実際のレート）**
- 🌟 **リアルタイム更新対応（1分間隔）**
- 🌟 **完全無料・APIキー不要のサービスを採用**
- 🌟 **フォールバック機能実装（API障害時も動作継続）**
- 実際の為替レートAPIを統合（以前はFrankfurter API）
- 入金証拠金入力フィールドの追加
- ロスカット率の選択機能追加
- 証拠金維持率の計算と色分け表示
- ロスカットレート・pips計算の実装
- 余剰証拠金と取引可否判定の追加
- UIの大幅改善（リスク管理情報の表示）
- ヘッダーにレート取得元表示追加

---

**開発ステータス**: ✅ 本番対応完了 | 🌟 実際のFX市場レート使用中（高精度）
